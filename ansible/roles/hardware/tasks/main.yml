---
- name: Hardware | Normalize knobs (always define facts)
  ansible.builtin.set_fact:
    hardware_is_laptop: false
    hardware_has_bluetooth: false

- name: Hardware | Normalize enable flags to tri-state strings
  ansible.builtin.set_fact:
    _hw_laptop_mode: "{{ (hardware_enable_laptop | string) | lower }}"
    _hw_bt_mode: "{{ (hardware_enable_bluetooth | string) | lower }}"

- name: Hardware | Detect laptop (BAT* present)
  ansible.builtin.shell: "ls /sys/class/power_supply/BAT* >/dev/null 2>&1"
  register: hardware_bat_check
  changed_when: false
  failed_when: false

- name: Hardware | Set laptop fact
  ansible.builtin.set_fact:
    hardware_is_laptop: >-
      {{
        true if _hw_laptop_mode == 'true'
        else (hardware_bat_check.rc == 0) if _hw_laptop_mode == 'auto'
        else false
      }}

- name: Hardware | Detect bluetooth (sysfs)
  ansible.builtin.stat:
    path: /sys/class/bluetooth
  register: hardware_bluetooth_sys

- name: Hardware | Set bluetooth fact
  ansible.builtin.set_fact:
    hardware_has_bluetooth: >-
      {{
        true if _hw_bt_mode == 'true'
        else (hardware_bluetooth_sys.stat.exists | default(false)) if _hw_bt_mode == 'auto'
        else false
      }}

# --- feature includes ---
- name: Hardware | fwupd
  ansible.builtin.include_tasks: fwupd.yml
  when: hardware_enable_fwupd | bool

- name: Hardware | bluetooth
  ansible.builtin.include_tasks: bluetooth.yml
  when: hardware_has_bluetooth | bool

- name: Hardware | laptop power
  ansible.builtin.include_tasks: laptop.yml
  when: hardware_is_laptop | bool

- name: Hardware | printer
  ansible.builtin.include_tasks: printer.yml
  when: hardware_enable_printer | bool

- name: Hardware | logitech
  ansible.builtin.include_tasks: logitech.yml
  when: hardware_enable_logitech | bool

- name: Hardware | zsa keyboards
  ansible.builtin.include_tasks: zsa.yml
  when: hardware_enable_zsa | bool
